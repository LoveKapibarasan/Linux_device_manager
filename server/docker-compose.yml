services:
  redis:
    container_name: redis
    image: docker.io/valkey/valkey:8-alpine
    command: ["redis-server", "--notify-keyspace-events", "Ex"]
    restart: unless-stopped
    volumes:
      - valkey-data2:/data
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    labels:
      app: 'redis'
    networks:
      - network

# https://github.com/searxng/searxng-docker/blob/master/
  searxng:
    container_name: searxng
    image: docker.io/searxng/searxng:latest
    restart: unless-stopped
    # https://github.com/searxng/searxng-docker/issues/423
    ports:
       - "8081:8081"
    volumes:
      - ./searxng:/etc/searxng:rw
      - searxng-data:/var/cache/searxng:rw
    environment:
      - SEARXNG_BASE_URL=https://search.lovekapibarasan.org/
      - GRANIAN_PORT=8081
    depends_on:
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    labels:
      app: searxng
      #traefik.enable: "true"
      # Router
      #traefik.http.routers.search.rule: Host(`search.lovekapibarasan.org`)
      #traefik.http.routers.search.entrypoints: websecure
      #traefik.http.routers.search.tls.certresolver: le
      # Service
      #traefik.http.services.search.loadbalancer.server.port: "8081"
    networks:
      - network

  # You may need sudo chmod 777 ./traefik-data/logs 
  traefik:
    image: traefik:latest
    container_name: "traefik"
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      #- "--certificatesresolvers.le.acme.httpchallenge=true"
      #- "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
      # Use Claudflare
      - "--certificatesresolvers.le.acme.dnschallenge=true"
      - "--certificatesresolvers.le.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.le.acme.email=${CF_API_EMAIL}"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
      - "--api.dashboard=true"
      - "--accesslog=true"
      - "--accesslog.format=json" # JSON形式を指定
      - "--accesslog.fields.names.ClientAddr=keep" # IPアドレスを保持
      # 【重要】書き出し先のパスを明示的に指定
      - "--accesslog.filepath=/logs/access.log"
           # Config
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      # Trust the IP address that argued by these companies
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=173.245.48.0/20,103.21.244.0/22,103.22.200.0/22,103.31.4.0/22,141.101.64.0/18,108.162.192.0/18,190.93.240.0/20,188.114.96.0/20,197.234.240.0/22,198.41.128.0/17,162.158.0.0/15,104.16.0.0/13,104.24.0.0/14,172.64.0.0/13,131.0.72.0/22"
      # 2. Docker Gateway IP（172.20.0.1）
      - "--entrypoints.websecure.forwardedHeaders.insecure=false"
      # 3. ClientAddr of log X-Forwarded-For（Real IP）を反映させる
      - "--accesslog.fields.names.ClientAddr=keep"
    ports:
      - "80:80"
      - "443:443"
      - "8082:8080"
    environment:
    # https://medium.com/@svenvanginkel/the-ultimate-guide-to-setting-up-traefik-650bd68ae633
      #- CF_API_EMAIL=${CF_API_EMAIL}
      - CF_DNS_API_TOKEN=${CF_API_KEY}
      #- CF_API_KEY=${CF_API_KEY}
      - TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN=${TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN}
    labels:
      app: traefik
      traefik.enable: true
      # Dashboard Router
      traefik.http.routers.traefik.rule: Host(`traefik.lovekapibarasan.org`)
      traefik.http.routers.traefik.entrypoints: websecure
      traefik.http.routers.traefik.tls.certresolver: le
      # Service は internal api
      traefik.http.routers.traefik.service: api@internal
      # Basic Auth
      traefik.http.middlewares.dashboard-auth.basicauth.users: ${BASIC_AUTH}
      traefik.http.routers.traefik.middlewares: dashboard-auth
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/letsencrypt:/letsencrypt
      - ./traefik/dynamic_conf.yml:/etc/traefik/dynamic/dynamic_conf.yml
      - ./traefik-data/logs:/logs
    networks:
      - network

  # --- Traefik Log Dashboard Agent (ログを解析) ---
  traefik-agent:
    image: hhftechnology/traefik-log-dashboard-agent:latest
    container_name: traefik-agent
    restart: unless-stopped
    environment:
      - TRAEFIK_LOG_DASHBOARD_ACCESS_PATH=/logs/access.log
      - TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN=${TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN}
      # 地図を有効化
      - TRAEFIK_LOG_DASHBOARD_GEOIP_ENABLED=true
      # データベースの保存先
      - TRAEFIK_LOG_DASHBOARD_GEOIP_DB_PATH=/data/GeoLite2-City.mmdb
    labels:
      app: traefik-agent
    volumes:
      - ./traefik-data/logs:/logs:ro # Traefikのログを読み取り専用でマウント
      - ./traefik-data/positions:/data # 読み取り位置を保存（再起動対策）
    ports:
      - "5000:5000"
    networks:
      - network

  # --- Traefik Log Dashboard  ---
  traefik-dashboard:
    image: hhftechnology/traefik-log-dashboard:latest
    container_name: traefik-dashboard
    restart: unless-stopped
    environment:
      - AGENT_API_URL=http://traefik-agent:5000
      - AGENT_API_TOKEN=${TRAEFIK_LOG_DASHBOARD_AUTH_TOKEN}
    labels:
      app: traefik-dashboard
      traefik.enable: "true"
      traefik.http.routers.tdash.rule: Host(`tdash.lovekapibarasan.org`)
      traefik.http.routers.tdash.entrypoints: websecure
      traefik.http.routers.tdash.tls.certresolver: le
      traefik.http.services.tdash.loadbalancer.server.port: "3000"
    ports:
      - "8098:3000"
    depends_on:
      - traefik-agent  
    networks:
      - network

  pihole:
      container_name: pihole
      image: pihole/pihole:latest
      ports:
        # DNS Ports
        - "53:53/tcp"
        - "53:53/udp"
        # Default HTTP Port
        - "8083:80/tcp"
        # Default HTTPs Port. FTL will generate a self-signed certificate
        #- "443:443/tcp"
        # Uncomment the below if using Pi-hole as your DHCP Server
        #- "67:67/udp"
        # Uncomment the line below if you are using Pi-hole as your NTP server
        #- "123:123/udp"
      environment:
        # Set the appropriate timezone for your location from
        # https://en.wikipedia.org/wiki/List_of_tz_database_time_zones, e.g:
        TZ: 'Europe/Berlin'
        # If using Docker's default `bridge` network setting the dns listening mode should be set to 'ALL'
        FTLCONF_dns_listeningMode: 'ALL'
        # https://docs.pi-hole.net/docker/configuration/
        FTLCONF_dns_upstreams: '8.8.8.8;1.1.1.1'
        #FTLCONF_webserver_port: '8082,8443s'
        FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD}
        FTLCONF_debug_api: 'true'
      # Volumes store your data between container upgrades
      # https://gist.github.com/kaczmar2/027fd6f64f4e4e7ebbb0c75cb3409787
      volumes:
        # For persisting Pi-hole's databases and common configuration file
        - pihole:/etc/pihole
        # Uncomment the below if you have custom dnsmasq config files that you want to persist. Not needed for most starting fresh with Pi-hole v6. If you're upgrading from v5 you and have used this directory before, you should keep it enabled for the first v6 container start to allow for a complete migration. It can be removed afterwards. Needs environment variable FTLCONF_misc_etc_dnsmasq_d: 'true'
        #- './etc-dnsmasq.d:/etc/dnsmasq.d'
      cap_add:
        # See https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
        # Required if you are using Pi-hole as your DHCP server, else not needed
        - NET_ADMIN
        # Required if you are using Pi-hole as your NTP client to be able to set the host's system time
        - SYS_TIME
        # Optional, if Pi-hole should get some more processing time
        - SYS_NICE
      restart: unless-stopped
      labels:
        app: pihole
        #traefik.enable: "true"
        #traefik.http.routers.pihole.rule: Host(`pihole.lovekapibarasan.org`)
        #traefik.http.routers.pihole.entrypoints: websecure
        #traefik.http.routers.pihole.tls.certresolver: le
        #traefik.http.services.pihole.loadbalancer.server.port: "80"
      networks:
        network:
          ipv4_address: 172.20.0.10

  unbound:
    image: mvance/unbound:latest
    container_name: unbound
    hostname: unbound
    ports:
      - "853:853/tcp"
    volumes:
      - ./unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    restart: unless-stopped
    labels:
      app: unbound
    networks:
      network:

  wireguard:
    image: linuxserver/wireguard:latest
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - SERVERURL=10.10.0.1
    volumes:
      # /config/wg0.conf
      - /etc/wireguard:/config
      - /lib/modules:/lib/modules
    #sysctls:
    #   - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
    labels:
      app: wireguard
    network_mode: host

  # https://dev.to/teetoflame/setting-up-a-gitlab-server-community-edition-and-a-gitlab-runner-using-docker-compose-ob6
  gitlab-server:
    image: 'gitlab/gitlab-ce:latest'
    container_name: gitlab-server
    hostname: 'gitlab.lovekapibarasan.org'
    environment:
          GITLAB_OMNIBUS_CONFIG: |
            external_url 'https://gitlab.lovekapibarasan.org'  # Put the IP of your server
            gitlab_rails['gitlab_shell_host'] = 'gitlab.lovekapibarasan.org'
            gitlab_rails['gitlab_shell_ssh_port'] = 2224
            gitlab_rails['trusted_proxies'] = ['172.20.0.0/24']
            gitlab_rails['initial_root_password'] =  "$GITLAB_PASSWORD"  # Set your initial root password here
            nginx['listen_port'] = 80
            nginx['listen_https'] = false
    ports:
      - '8084:80'  # Expose GitLab on port 8088
      - '2224:22' # Do not use ssh on 22 in host. sudo ss -tlnp | grep sshd
    volumes:
      - gitlab-config:/etc/gitlab  # Persist GitLab configuration
      - gitlab-logs:/var/log/gitlab  # Persist GitLab logs
      - gitlab-data:/var/opt/gitlab  # Persist GitLab data
    restart: always
    labels:
      app: gitlab-server
      traefik.enable: "true"
      traefik.http.routers.gitlab.rule: Host(`gitlab.lovekapibarasan.org`)
      traefik.http.routers.gitlab.entrypoints: websecure
      traefik.http.routers.gitlab.tls.certresolver: le
      traefik.http.services.gitlab.loadbalancer.server.port: "80"
    networks:
      - network

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    environment:
      # https://github.com/dani-garcia/vaultwarden/discussions/4497
        - DOMAIN=https://password.lovekapibarasan.org
        - ROCKET_PORT=8085
    volumes:
      - vw-data:/data/
    ports:
      - '8085:8085'
    labels:
      app: vaultwarden
      #traefik.enable: "true"
      #traefik.http.routers.password.rule: Host(`password.lovekapibarasan.org`)
      #traefik.http.routers.password.entrypoints: websecure
      #traefik.http.routers.password.tls.certresolver: le
      #traefik.http.services.password.loadbalancer.server.port: "8085"
    networks:
      - network

  db:
    image: mariadb:latest
    container_name: db
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}  # MYSQL_ → MARIADB_
      ROUNDCUBE_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
    labels:
      app: mariadb
    networks:
      - network

  wordpress:
    container_name: wordpress
    depends_on:
      - db
    image: wordpress:latest
    ports:
      - "8086:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_NAME: wordpress
    volumes:
      - wordpress_data:/var/www/html
      #- ./ports.conf:/etc/apache2/ports.conf:ro
    labels:
      app: wordpress
      traefik.enable: "true"
      traefik.http.routers.root.rule: Host(`lovekapibarasan.org`)
      traefik.http.routers.root.entrypoints: websecure
      traefik.http.routers.root.tls.certresolver: le
      traefik.http.services.root.loadbalancer.server.port: "80"

    networks:
      - network

# https://github.com/dockur/samba/blob/master/compose.yml
  samba:
    image: dockurr/samba
    container_name: samba
    environment:
      NAME: "Data" # Folder name
      USER: "samba" # user name
      PASS: "$SAMBA_PASSWORD"
      # Read and Write
      RW: true      # Optional, default true
      UID: 1000    # Optional, default 1000
      GID: 1000    # Optional, default 1000
    ports:
      - 445:445
    volumes:
      - ./samba:/storage
    restart: always
    labels:
      app: samba
    networks:
      - network

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    user: 1000:1000
    ports:
      - 8087:8096
    volumes:
      - jellyfin-config:/config
      - jellyfin-cache:/cache
      - ./samba/media:/media:ro  # Media file location
    restart: unless-stopped
    labels:
      app: jellyfin
      traefik.enable: "true"
      traefik.http.routers.media.rule: Host(`media.lovekapibarasan.org`)
      traefik.http.routers.media.entrypoints: websecure
      traefik.http.routers.media.tls.certresolver: le
      traefik.http.services.media.loadbalancer.server.port: "8096"

    networks:
      - network

# https://blog.estampie.work/archives/3343
# https://docker-mailserver.github.io/docker-mailserver/latest/usage/
  mailserver:
    image: docker.io/mailserver/docker-mailserver:latest
    container_name: mailserver
    env_file: mailserver.env
    hostname: mail.lovekapibarasan.org
    ports:
      - "25:25"      # SMTP
      - "143:143"    # IMAP
      - "587:587"    # Submission
      - "465:465"    # SMTPS
      - "993:993"    # IMAPS
    volumes:
      - mail-data:/var/mail # mail data
      - mail-state:/var/mail-state
      - mail-logs:/var/log/mail # logs
      - mail-config:/tmp/docker-mailserver
      - /etc/localtime:/etc/localtime:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    cap_add:
      - NET_ADMIN
    environment:
      - SSL_TYPE=manual  # ← letsencrypt
      - SSL_CERT_PATH=/etc/letsencrypt/live/lovekapibarasan.org/fullchain.pem
      - SSL_KEY_PATH=/etc/letsencrypt/live/lovekapibarasan.org/privkey.pem
      - TLS_LEVEL=intermediate
    restart: always
    stop_grace_period: 1m
    healthcheck:
      test: "ss --listening --ipv4 --tcp | grep --silent ':smtp' || exit 1"
      timeout: 3s
      retries: 5
    labels:
      app: mainserver
    networks:
      - network

  roundcube:
    image: roundcube/roundcubemail:latest
    container_name: roundcube
    ports:
      - "8088:80"
    environment:
      ROUNDCUBEMAIL_DB_TYPE: mysql # MariaDB is originated from mySQL
      ROUNDCUBEMAIL_DB_HOST: db
      ROUNDCUBEMAIL_DB_USER: roundcube
      ROUNDCUBEMAIL_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      ROUNDCUBEMAIL_DB_NAME: roundcube
      ROUNDCUBE_OAUTH_GOOGLE_CLIENT_ID: $GOOGLE_CLIENT_ID
      ROUNDCUBE_OAUTH_GOOGLE_CLIENT_SECRET: $GOOGLE_CLIENT_SECRET
    depends_on:
      # - mailserver
      - db
    restart: unless-stopped
    volumes:
       - ./roundcube/config:/var/www/html/config
    # config/config.docker.inc.php
    labels:
      app: roundcube
      traefik.enable: "true"
      traefik.http.routers.roundcube.rule: Host(`roundcube.lovekapibarasan.org`)
      traefik.http.routers.roundcube.entrypoints: websecure
      traefik.http.routers.roundcube.tls.certresolver: le
      traefik.http.services.roundcube.loadbalancer.server.port: "80"

    networks:
      - network

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "8089:8080"
    volumes:
      - open-webui:/app/backend/data
    restart: always
    labels:
      app: open-webui
      traefik.enable: "true"
      traefik.http.routers.ai.rule: Host(`ai.lovekapibarasan.org`)
      traefik.http.routers.ai.entrypoints: websecure
      traefik.http.routers.ai.tls.certresolver: le
      traefik.http.services.ai.loadbalancer.server.port: "8080"
    networks:
      - network

  tts-azure-web:
    container_name: tts-azure-web
    build: ./tts-azure-web
    ports:
      - "8090:3000"
    environment:
      - SPEECH_KEY=${SPEECH_KEY}
      - SPEECH_REGION=${SPEECH_REGION}
      - DEMO_MODE=false
    labels:
      app: tts-azure-web
      traefik.enable: "true"
      traefik.http.routers.tts.rule: Host(`tts.lovekapibarasan.org`)
      traefik.http.routers.tts.entrypoints: websecure
      traefik.http.routers.tts.tls.certresolver: le
      traefik.http.services.tts.loadbalancer.server.port: "3000"
      traefik.http.middlewares.auth.basicauth.users: ${TTS_BASIC_AUTH}
      traefik.http.routers.tts.middlewares: auth
    networks:
      - network

  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: always
    ports:
      - "8091:80"
    volumes:
      - nextcloud_data:/var/www/html
    environment:
      MYSQL_HOST: db
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_PASSWORD: $NEXTCLOUD_DB_PASSWORD
      NEXTCLOUD_ADMIN_USER: $NEXTCLOUD_ADMIN_USER
      NEXTCLOUD_ADMIN_PASSWORD: $NEXTCLOUD_ADMIN_PASSWORD
      NEXTCLOUD_TRUSTED_DOMAINS: localhost 127.0.0.1 nextcloud.lovekapibarasan.org
    depends_on:
      - db
    labels:
      app: nextcloud
      traefik.enable: "true"
      traefik.http.routers.nextcloud.rule: Host(`nextcloud.lovekapibarasan.org`)
      traefik.http.routers.nextcloud.entrypoints: websecure
      traefik.http.routers.nextcloud.tls.certresolver: le
      traefik.http.services.nextcloud.loadbalancer.server.port: "80"
    networks:
      - network

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    ports:
      - "8092:9000"     # Web UI（HTTP）
      - "8000:8000"     # Edge Agent
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      app: portainer
      #traefik.enable: "true"
      #traefik.http.routers.docker.rule: Host(`docker.lovekapibarasan.org`)
      #traefik.http.routers.docker.entrypoints: websecure
      #traefik.http.routers.docker.tls.certresolver: le
      #traefik.http.services.docker.loadbalancer.server.port: "9000"
    networks:
      - network

# Obsidian + MkDocs + Samba
  mkdocs:
    image: squidfunk/mkdocs-material
    container_name: mkdocs
    volumes:
      - ./samba/memo:/docs
    ports:
      - "8093:8000"
    command: serve -a 0.0.0.0:8000
    labels:
      app: mkdocs
      traefik.enable: "true"
      traefik.http.routers.memo.rule: "Host(`memo.lovekapibarasan.org`)"
      traefik.http.routers.memo.entrypoints: websecure
      traefik.http.routers.memo.tls.certresolver: le
      traefik.http.services.memo.loadbalancer.server.port: "8000"
    networks:
      - network

# !! Deprecated !!
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      # Receieves log from internet
      - "--web.enable-remote-write-receiver"
    ports:
      - "9090:9090"
    restart: always
    labels:
      app: prometheus
    networks:
      - network

  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter
    ports:
      - "9100:9100"
    restart: always
    labels:
      app: node_exporter
    networks:
      - network

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    privileged: true
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    restart: always
    labels:
      app: cadvisor
    networks:
      - network

  alloy:
    image: 'grafana/alloy:v1.11.3'
    container_name: "alloy"
    # http://localhost:12345
    command:
      [
        'run',
        '--server.http.listen-addr',
        '0.0.0.0:12345',
        '--storage.path',
        '/var/lib/alloy/data',
        '--stability.level',
        'public-preview',
        '/etc/alloy/config.alloy',
      ]
    volumes:
      # https://community.grafana.com/t/am-i-missing-something-running-all-pieces-in-docker-compose/147152
      - /var/run/docker.sock:/var/run/docker.sock
      - ./alloy/config.alloy:/etc/alloy/config.alloy:ro
    ports:
      - "12345:12345"
    networks:
      - network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "8094:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=$GRAFANA_PASSWORD
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://grafana.lovekapibarasan.org
    restart: always
    depends_on:
      - prometheus
      - loki
    volumes:
      - grafana-storage:/var/lib/grafana
    labels:
      app: grafana
      #traefik.enable: "true"
      #traefik.http.routers.log.rule: "Host(`log.lovekapibarasan.org`)"
      #traefik.http.routers.log.entrypoints: websecure
      #traefik.http.routers.log.tls.certresolver: le
      #traefik.http.services.log.loadbalancer.server.port: "3000"
    networks:
      - network

  loki:
    image: grafana/loki:latest
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    volumes:
      - loki-data:/loki
      - ./loki/local-config.yaml:/etc/loki/local-config.yaml:ro
    restart: always
    labels:
      app: loki
    networks:
      - network

# !! Deprecated !!
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml
    command: -config.file=/etc/promtail/promtail.yml
    depends_on:
      - loki
    restart: always
    labels:
      app: promtail
    networks:
      - network

  mimir:
    image: grafana/mimir:latest
    container_name: mimir
    command:
      - "-config.file=/etc/mimir/mimir.yaml"
    volumes:
      - ./mimir/mimir.yaml:/etc/mimir/mimir.yaml
      - mimir-data:/data
    ports:
      - "9009:9009"
    depends_on:
      - minio
    environment:
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      restart: unless-stopped
    labels:
      app: mimir
    networks:
      - network

  minio:
    #image: minio/minio:latest
    # For very old CPU
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z-cpuv1
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: $MINIO_ROOT_PASSWORD
    volumes:
      - minio-data:/data
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console
    restart: unless-stopped
    labels:
      app: minio
      traefik.enable: "true"
      traefik.http.routers.minio.rule: Host(`minio.lovekapibarasan.org`)
      traefik.http.routers.minio.entrypoints: websecure
      traefik.http.routers.minio.tls.certresolver: le
      traefik.http.services.minio.loadbalancer.server.port: "9001"
    networks:
      - network

  n8n:
    image: n8nio/n8n:latest
    container_name: "n8n"
    restart: unless-stopped
    ports:
      - "8095:5678"
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=n8n.lovekapibarasan.org
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=https://n8n.lovekapibarasan.org/
      - GENERIC_TIMEZONE=Europe/Berlin
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      - postgres
    labels:
      app: n8n
      traefik.enable: "true"
      traefik.http.routers.n8n.rule: Host(`n8n.lovekapibarasan.org`)
      traefik.http.routers.n8n.entrypoints: websecure
      traefik.http.routers.n8n.tls.certresolver: le
      traefik.http.services.n8n.loadbalancer.server.port: "5678"
    networks:
      - network

  postgres:
    image: postgres:latest
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: ${N8N_DB_PASSWORD}
    volumes:
    # Version 18
      - postgres_data:/var/lib/postgresql
    labels:
      app: postgres
    networks:
      - network

#  head /dev/urandom | LC_ALL=C tr -dc 'A-Za-z0-9' | head -c 32 && echo
  firefly_iii:
    image: fireflyiii/core:latest
    hostname: firefly_iii
    container_name: firefly_iii
    restart: always
    volumes:
      - firefly_iii_upload:/var/www/html/storage/upload
    env_file: .env
    ports:
      - 8096:8080
    depends_on:
      - db
    labels:
      app: firefly_iii
      #traefik.enable: "true"
      #traefik.http.routers.expense.rule: Host(`expense.lovekapibarasan.org`)
      #traefik.http.routers.expense.entrypoints: websecure
      #traefik.http.routers.expense.tls.certresolver: le
      #traefik.http.services.expense.loadbalancer.server.port: "8080"
    networks:
      - network

  cron:
    #
    # To make this work, set STATIC_CRON_TOKEN in your .env file or as an environment variable
    # The STATIC_CRON_TOKEN must be *exactly* 32 characters long
    #
    image: alpine
    restart: always
    container_name: firefly_iii_cron
    env_file: .env
    command: sh -c "
        apk add tzdata && \
        (ln -s /usr/share/zoneinfo/$$TZ /etc/localtime || true) && \
        echo \"0 3 * * * wget -qO- http://app:8080/api/v1/cron/$$STATIC_CRON_TOKEN;echo\"
        | crontab - && \
        crond -f -L /dev/stdout"
    depends_on:
      - firefly_iii
    labels:
      app: cron
    networks:
      - network
  
  # Super Productivity Application
  super-productivity:
    image: johannesjo/super-productivity:latest
    container_name: super-productivity-app
    ports:
      - "8097:80"
    restart: always
    labels:
      app: superproductivity
      traefik.enable: "true"
      traefik.http.routers.tasks.rule: Host(`tasks.lovekapibarasan.org`)
      traefik.http.routers.tasks.entrypoints: websecure
      traefik.http.routers.tasks.tls.certresolver: le
      traefik.http.services.tasks.loadbalancer.server.port: "80"
    depends_on:
      - "webdav"
    networks:
      - network

  # 同期用 WebDAV サーバー (hacdias/webdav を使用)
  webdav:
    image: hacdias/webdav:latest
    container_name: webdav
    ports:
      - "2345:2345"
    volumes:
      - ./webdav/webdav.yaml:/config.yml:ro
      - ./data:/data
    restart: always
    labels: 
      app: webdav
      traefik.enable: "true"
      traefik.http.routers.webdav.rule: Host(`webdav.lovekapibarasan.org`)
      traefik.http.routers.webdav.entrypoints: websecure
      traefik.http.routers.webdav.tls.certresolver: le
      traefik.http.services.webdav.loadbalancer.server.port: "2345"
      # ミドルウェア設定
      traefik.http.routers.webdav.middlewares: webdav-cors
      # CORS設定
      traefik.http.middlewares.webdav-cors.headers.accesscontrolalloworiginlist: "https://tasks.lovekapibarasan.org"
      traefik.http.middlewares.webdav-cors.headers.accesscontrolallowmethods: "GET,OPTIONS,PUT,DELETE,PROPFIND,PROPPATCH,MKCOL,COPY,MOVE,LOCK,UNLOCK"
      traefik.http.middlewares.webdav-cors.headers.accesscontrolallowheaders: "*"
      traefik.http.middlewares.webdav-cors.headers.accesscontrolallowcredentials: "true"
      traefik.http.middlewares.webdav-cors.headers.accesscontrolmaxage: "100"
    networks:
      - network

  restic:
      image: restic/rest-server:latest
      container_name: restic
      restart: always
      ports:
        - "8000:8000"
      volumes:
        - ./data:/data          # バックアップデータの保存先
      labels:
        app: restic
      environment:
        - OPTIONS=--append-only # 過去のデータを上書き禁止にする（セキュリティ向上）
      networks:
        - network
#============================================        
# Memo: Skip: 8098
#============================================

  portainer_agent:
    image: portainer/agent:latest
    container_name: portainer_agent
    restart: always
    ports:
      - "9002:9001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - portainer_agent_data:/data
    environment:
      AGENT_CLUSTER_ADDR: tasks.portainer_agent    
    networks:
      - network

volumes:
  valkey-data2:
  searxng-data:
  db_data:
  wordpress_data:
  open-webui:
  nextcloud_data:
  anki_data:
  portainer_data:
  prometheus_data:
  grafana-storage: {}
  loki-data:
  pihole:
  vw-data:
  gitlab-config:
  gitlab-data:
  gitlab-logs:
  mail-data:
  mail-state:
  mail-logs:
  mail-config:
  jellyfin-config:
  jellyfin-cache:
  n8n_data:
  postgres_data:
  firefly_iii_upload:
  minio-data:
  mimir-data:
  portainer_agent_data:

networks:
  network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
